@using System.Linq.Expressions
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@inherits ComponentBase

@*
    EditBase.razor - A base component for creating reusable form input controls.
    
    This component demonstrates modern .NET 10 / C# 14 patterns:
    - FieldIdentifier for expression parsing (Blazor's built-in approach)
    - ArgumentNullException.ThrowIfNull for cleaner guard clauses
    - Null-coalescing operators for concise null handling
    
    Inherit from this component to create custom input controls that automatically
    extract labels from [Display] attributes and integrate with Blazor's EditForm.
*@

@code {
    /// <summary>
    /// The EditContext from the parent EditForm component.
    /// Cascading parameters automatically flow down from ancestor components,
    /// allowing child components to access form state without explicit parameter passing.
    /// </summary>
    [CascadingParameter]
    protected EditContext? CurrentEditContext { get; set; }

    /// <summary>
    /// Expression pointing to the model property this input is bound to.
    /// Usage: For="() => Model.PropertyName"
    /// 
    /// Using Expression&lt;Func&lt;object&gt;&gt; instead of just Func&lt;object&gt; preserves
    /// the expression tree, allowing us to inspect the property metadata at runtime.
    /// This is the same pattern used by Blazor's built-in ValidationMessage component.
    /// </summary>
    [Parameter]
    public Expression<Func<object>>? For { get; set; }

    /// <summary>
    /// The display label for the input, extracted from [Display(Name = "...")] 
    /// attribute or defaulting to the property name.
    /// </summary>
    protected string? Label { get; set; }

    /// <summary>
    /// PropertyInfo for the bound property, used by derived components
    /// to get/set values via reflection.
    /// </summary>
    protected PropertyInfo? Property { get; private set; }

    protected override void OnParametersSet()
    {
        // Modern guard clause - concise and auto-includes parameter name in exception.
        ArgumentNullException.ThrowIfNull(For);
        
        // Blazor's built-in expression parser handles property access, boxing, and nested properties.
        var fieldIdentifier = FieldIdentifier.Create(For);
        
        // Extract PropertyInfo using the model instance and field name from FieldIdentifier.
        Property = fieldIdentifier.Model.GetType().GetProperty(fieldIdentifier.FieldName)
            ?? throw new InvalidOperationException(
                $"Property '{fieldIdentifier.FieldName}' not found on type '{fieldIdentifier.Model.GetType().Name}'");

        // Use [Display] attribute name if present, otherwise fall back to property name.
        Label = Property.GetCustomAttribute<DisplayAttribute>()?.Name ?? Property.Name;
    }
}